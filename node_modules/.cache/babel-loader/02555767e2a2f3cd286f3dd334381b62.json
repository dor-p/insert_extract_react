{"ast":null,"code":"import _createClass from \"/Users/dor/Desktop/react-crud-admin/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/dor/Desktop/react-crud-admin/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/dor/Desktop/react-crud-admin/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/dor/Desktop/react-crud-admin/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _classCallCheck from \"/Users/dor/Desktop/react-crud-admin/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nvar _jsxFileName = \"/Users/dor/Desktop/react-crud-admin/src/voter.js\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"]; if (!it) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = it.call(o); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nimport React from \"react\";\nimport Admin from \"./admin.js\";\nimport Form from \"react-jsonschema-form\";\nimport _ from \"lodash\";\nimport moment from \"moment\";\n\nvar uuidv1 = require(\"uuid/v1\");\n\nrequire(\"./admin.scss\");\n\nvar QueryParam = function QueryParam() {\n  var name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : \"\";\n  var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : \"\";\n  var is_string = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n  _classCallCheck(this, QueryParam);\n\n  this.name = name;\n  this.value = value;\n  this.is_string = is_string;\n};\n\nfunction build_params(params) {\n  var val = [];\n\n  var _iterator = _createForOfIteratorHelper(params),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var param = _step.value;\n\n      var _escape = param.is_string ? '\"' : \"\";\n\n      val.push(param.name + \"=\" + _escape + param.value + _escape);\n      return \"?\" + _.join(val, \"&\");\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n}\n\nfunction build_composite_key(keys) {\n  var f = keys.map(function (key) {\n    if (typeof key == \"string\") {\n      return '\"' + key + '\"';\n    } else {\n      return key;\n    }\n  });\n  return \"[\" + _.join(f, \",\") + \"]\";\n}\n/*\n  params=build_params(\n  QueryParam(\"reduce\",\"false\"),\n                                QueryParam(\"key\",build_composite_key(\n                                        election,\n                                        token)\n                                )\n                        )\n\n*/\n\n\nexport var default_headers = new Headers();\ndefault_headers.set(\"Content-Type\", \"application/json\");\ndefault_headers.set(\"Accept\", \"application/json\");\n\nif (window.ELECTION == \"undefined\" || typeof window.ELECTION === \"undefined\") {\n  window.SERVER = \"http://localhost:8000\";\n  window.ELECTION = \"NIM2017\";\n}\n\nexport var Voter = /*#__PURE__*/function (_Admin) {\n  _inherits(Voter, _Admin);\n\n  function Voter() {\n    var _this;\n\n    _classCallCheck(this, Voter);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Voter).call(this));\n    _this.name = \"Voter\";\n    _this.name_plural = \"Voters\";\n    _this.list_display_links = [\"id\", \"names\"];\n    _this.list_per_page = 50;\n    _this.header_transforms = {\n      \"emails[0]\": function emails0(label) {\n        return \"Email\";\n      },\n      \"phones[0]\": function phones0(label) {\n        return \"Phone\";\n      },\n      id: function id(label) {\n        return \"Membership No\";\n      }\n    };\n    _this.extra_fields = {\n      now: function now(object, label) {\n        return moment(new Date()).format(\"LLL\");\n      }\n    };\n    _this.field_transforms = {\n      created: function created(_created, object) {\n        if (_created) {\n          var c = moment(new Date(_created));\n\n          if (c.isValid()) {\n            return c.format(\"LLL\");\n          } else {\n            return \"\";\n          }\n        } else {\n          return \"\";\n        }\n      }\n    };\n    _this.schema = {\n      title: _this.name,\n      type: \"object\",\n      required: [\"names\", \"id\"],\n      properties: {\n        type: {\n          type: \"string\",\n          title: \"Type\",\n          default: \"voter\"\n        },\n        names: {\n          type: \"string\",\n          title: \"Names\"\n        },\n        token: {\n          type: \"object\",\n          properties: {\n            token: {\n              type: \"string\",\n              default: _.join(_.sampleSize(\"ABCDEFGUIJKLMNPQRSTUVWXYZ123456789\", 8), \"\")\n            },\n            expiry: {\n              type: \"string\"\n            }\n          }\n        },\n        cast: {\n          type: \"object\",\n          default: {}\n        },\n        id: {\n          type: \"string\",\n          title: \"ID\"\n        },\n        authorization: {\n          type: \"string\",\n          title: \"Authorization\",\n          default: uuidv1()\n        },\n        phones: {\n          type: \"array\",\n          title: \"Phone Numbers\",\n          items: {\n            type: \"string\"\n          }\n        },\n        emails: {\n          type: \"array\",\n          title: \"Email Addresses\",\n          items: {\n            type: \"string\"\n          }\n        },\n        allowed: {\n          type: \"array\",\n          title: \"Allowed Elections\",\n          items: {\n            type: \"object\",\n            properties: {\n              election: {\n                type: \"string\",\n                title: \"Election\",\n                default: \"demo\"\n              },\n              selection_groups: {\n                type: \"array\",\n                title: \"Selection Groups\",\n                items: {\n                  type: \"string\"\n                },\n                default: [\"council\", \"south-east\", \"south-south\", \"south-east\", \"north-east\", \"south-west\", \"north-central\", \"north-west\"]\n              }\n            }\n          }\n        }\n      }\n    };\n    return _this;\n  }\n\n  _createClass(Voter, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.form_submit = this.form_submit.bind(this);\n      this.response_change = this.response_change.bind(this);\n      this.response_add = this.response_add.bind(this); //this.nextPage=this.nextPage.bind(this);\n      //this.prevPage=this.prevPage.bind(this);\n      //this.get_queryset();\n    }\n  }, {\n    key: \"get_list_display\",\n    value: function get_list_display() {\n      return [\"id\", \"names\", \"created\", \"emails\", \"phones[0]\"];\n    }\n  }, {\n    key: \"sort_by\",\n    value: function sort_by(fields, queryset) {\n      var _this2 = this;\n\n      var path = window.SERVER + \"/voters/_find\";\n      var query = {\n        selector: {\n          created: {\n            $ne: null\n          },\n          names: {\n            $ne: null\n          }\n        },\n        sort: fields,\n        limit: this.list_per_page,\n        skip: (this.state.page_number - 1) * this.list_per_page\n      };\n      var app = this;\n      this.show_progress();\n      fetch(path, {\n        method: \"post\",\n        headers: default_headers,\n        body: JSON.stringify(query)\n      }).then(function (response) {\n        if (response.ok) {\n          response.json().then(function (results) {\n            _this2.hide_progress();\n\n            app.setState({\n              queryset: results.rows.filter(function (row) {\n                return row.type == \"voter\";\n              }).map(function (row) {\n                return row.value;\n              }),\n              total: results.total_rows\n            });\n          });\n        } else {\n          _this2.hide_progress();\n        }\n      }).catch(function (e) {\n        return _this2.hide_progress();\n      });\n      return [];\n    }\n  }, {\n    key: \"search\",\n    value: function search(term, queryset) {\n      var _this3 = this;\n\n      var query = {\n        selector: {\n          $or: [{\n            names: {\n              $regex: \"(?i)\" + term\n            }\n          }, {\n            emails: {\n              $elemMatch: {\n                $regex: \"(?i)\" + term\n              }\n            }\n          }, {\n            id: {\n              $regex: \"(?i)\" + term\n            }\n          }]\n        } //\t    \"fields\" : [\"_id\",\"_rev\",\"id\",\"names\",\"phones\",\"emails\",\"allowed\",\"type\"],\n\n      };\n      var path = window.SERVER + \"/voters/_find\";\n      var app = this;\n      this.show_progress();\n      fetch(path, {\n        method: \"post\",\n        headers: default_headers,\n        body: JSON.stringify(query)\n      }).then(function (response) {\n        if (response.ok) {\n          response.json().then(function (results) {\n            console.log(results);\n\n            _this3.hide_progress();\n\n            app.setState({\n              queryset: results.docs.filter(function (row) {\n                return row.type == \"voter\";\n              }).map(function (row) {\n                return row;\n              }),\n              total: 100\n            });\n          });\n        } else {\n          _this3.hide_progress();\n        }\n      }).catch(function (e) {\n        return _this3.hide_progress();\n      });\n      return queryset;\n    }\n  }, {\n    key: \"get_queryset\",\n    value: function get_queryset(page_number, list_per_page, queryset) {\n      var _this4 = this;\n\n      var path = window.SERVER + '/voters/_design/voter/_view/by_election?key=\"' + window.ELECTION + '\"&reduce=false' + \"&limit=\" + list_per_page + \"&skip=\" + (page_number - 1) * list_per_page;\n      console.log(path);\n      var app = this;\n      this.show_progress();\n      fetch(path, {\n        method: \"get\"\n      }).then(function (response) {\n        if (response.ok) {\n          response.json().then(function (results) {\n            _this4.hide_progress();\n\n            app.setState({\n              queryset: results.rows.map(function (row) {\n                return row.value;\n              }),\n              total: results.total_rows\n            });\n          });\n        }\n      });\n      return queryset;\n    }\n  }, {\n    key: \"get_form\",\n    value: function get_form() {\n      var object = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n      var hidden = {\n        \"ui:widget\": \"hidden\"\n      };\n      var readonly = {\n        \"ui:readonly\": \"true\"\n      };\n      var uiSchema = {\n        //  id: readonly,\n        // names: readonly,\n        // emails: readonly,\n        // phones: readonly,\n        token: readonly,\n        authorization: hidden,\n        type: hidden\n      };\n\n      if (!object) {\n        return /*#__PURE__*/React.createElement(Form, {\n          schema: this.schema,\n          uiSchema: uiSchema,\n          onSubmit: this.form_submit,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 305,\n            columnNumber: 9\n          }\n        });\n      } else {\n        return /*#__PURE__*/React.createElement(Form, {\n          schema: this.schema,\n          uiSchema: uiSchema,\n          formData: object,\n          onSubmit: this.form_submit,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 313,\n            columnNumber: 9\n          }\n        });\n      }\n    }\n  }, {\n    key: \"form_submit\",\n    value: function form_submit(form) {\n      var _this5 = this;\n\n      var voter = form.formData;\n      var id = voter[\"_id\"] ? voter[\"_id\"] : \"\";\n      var path = window.SERVER + \"/voters/\" + id;\n      console.log(path);\n      var url = form.edit ? path + \"?rev=\" + voter[\"_rev\"] : path;\n      var method = form.edit ? \"put\" : \"post\";\n      console.log(url);\n      fetch(url, {\n        method: method,\n        body: JSON.stringify(voter),\n        headers: default_headers\n      }).then(function (response) {\n        if (response.ok) {\n          var action = form.edit ? _this5.response_change : _this5.response_add;\n          action();\n        } else {\n          alert(response.statusText);\n        }\n      }).catch(function (response) {\n        alert(response);\n      });\n    }\n  }, {\n    key: \"has_add_permission\",\n    value: function has_add_permission() {\n      return true;\n    }\n  }]);\n\n  return Voter;\n}(Admin);","map":{"version":3,"sources":["/Users/dor/Desktop/react-crud-admin/src/voter.js"],"names":["React","Admin","Form","_","moment","uuidv1","require","QueryParam","name","value","is_string","build_params","params","val","param","_escape","push","join","build_composite_key","keys","f","map","key","default_headers","Headers","set","window","ELECTION","SERVER","Voter","name_plural","list_display_links","list_per_page","header_transforms","label","id","extra_fields","now","object","Date","format","field_transforms","created","c","isValid","schema","title","type","required","properties","default","names","token","sampleSize","expiry","cast","authorization","phones","items","emails","allowed","election","selection_groups","form_submit","bind","response_change","response_add","fields","queryset","path","query","selector","$ne","sort","limit","skip","state","page_number","app","show_progress","fetch","method","headers","body","JSON","stringify","then","response","ok","json","results","hide_progress","setState","rows","filter","row","total","total_rows","catch","e","term","$or","$regex","$elemMatch","console","log","docs","hidden","readonly","uiSchema","form","voter","formData","url","edit","action","alert","statusText"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport Admin from \"./admin.js\";\nimport Form from \"react-jsonschema-form\";\nimport _ from \"lodash\";\nimport moment from \"moment\";\n\nconst uuidv1 = require(\"uuid/v1\");\nrequire(\"./admin.scss\");\nclass QueryParam {\n  constructor(name = \"\", value = \"\", is_string = false) {\n    this.name = name;\n    this.value = value;\n    this.is_string = is_string;\n  }\n}\nfunction build_params(params) {\n  let val = [];\n\n  for (let param of params) {\n    let _escape = param.is_string ? '\"' : \"\";\n    val.push(param.name + \"=\" + _escape + param.value + _escape);\n    return \"?\" + _.join(val, \"&\");\n  }\n}\n\nfunction build_composite_key(keys) {\n  let f = keys.map(key => {\n    if (typeof key == \"string\") {\n      return '\"' + key + '\"';\n    } else {\n      return key;\n    }\n  });\n\n  return \"[\" + _.join(f, \",\") + \"]\";\n}\n\n/*\n  params=build_params(\n  QueryParam(\"reduce\",\"false\"),\n                                QueryParam(\"key\",build_composite_key(\n                                        election,\n                                        token)\n                                )\n                        )\n\n*/\n\nexport const default_headers = new Headers();\ndefault_headers.set(\"Content-Type\", \"application/json\");\ndefault_headers.set(\"Accept\", \"application/json\");\nif (window.ELECTION == \"undefined\" || typeof window.ELECTION === \"undefined\") {\n  window.SERVER = \"http://localhost:8000\";\n  window.ELECTION = \"NIM2017\";\n}\n\nexport class Voter extends Admin {\n  name = \"Voter\";\n  name_plural = \"Voters\";\n  list_display_links = [\"id\", \"names\"];\n  list_per_page = 50;\n  header_transforms = {\n    \"emails[0]\": label => \"Email\",\n    \"phones[0]\": label => \"Phone\",\n    id: label => \"Membership No\"\n  };\n  extra_fields = { now: (object, label) => moment(new Date()).format(\"LLL\") };\n  field_transforms = {\n    created: function(created, object) {\n      if (created) {\n        let c = moment(new Date(created));\n        if (c.isValid()) {\n          return c.format(\"LLL\");\n        } else {\n          return \"\";\n        }\n      } else {\n        return \"\";\n      }\n    }\n  };\n  schema = {\n    title: this.name,\n    type: \"object\",\n    required: [\"names\", \"id\"],\n    properties: {\n      type: { type: \"string\", title: \"Type\", default: \"voter\" },\n      names: { type: \"string\", title: \"Names\" },\n      token: {\n        type: \"object\",\n        properties: {\n          token: {\n            type: \"string\",\n            default: _.join(\n              _.sampleSize(\"ABCDEFGUIJKLMNPQRSTUVWXYZ123456789\", 8),\n              \"\"\n            )\n          },\n          expiry: { type: \"string\" }\n        }\n      },\n      cast: { type: \"object\", default: {} },\n      id: { type: \"string\", title: \"ID\" },\n      authorization: {\n        type: \"string\",\n        title: \"Authorization\",\n        default: uuidv1()\n      },\n      phones: {\n        type: \"array\",\n        title: \"Phone Numbers\",\n        items: { type: \"string\" }\n      },\n      emails: {\n        type: \"array\",\n        title: \"Email Addresses\",\n        items: { type: \"string\" }\n      },\n      allowed: {\n        type: \"array\",\n        title: \"Allowed Elections\",\n        items: {\n          type: \"object\",\n          properties: {\n            election: { type: \"string\", title: \"Election\", default: \"demo\" },\n            selection_groups: {\n              type: \"array\",\n              title: \"Selection Groups\",\n              items: { type: \"string\" },\n              default: [\n                \"council\",\n                \"south-east\",\n                \"south-south\",\n                \"south-east\",\n                \"north-east\",\n                \"south-west\",\n                \"north-central\",\n                \"north-west\"\n              ]\n            }\n          }\n        }\n      }\n    }\n  };\n\n  constructor() {\n    super();\n  }\n  componentDidMount() {\n    this.form_submit = this.form_submit.bind(this);\n    this.response_change = this.response_change.bind(this);\n    this.response_add = this.response_add.bind(this);\n    //this.nextPage=this.nextPage.bind(this);\n    //this.prevPage=this.prevPage.bind(this);\n    //this.get_queryset();\n  }\n  get_list_display() {\n    return [\"id\", \"names\", \"created\", \"emails\", \"phones[0]\"];\n  }\n\n  sort_by(fields, queryset) {\n    let path = window.SERVER + \"/voters/_find\";\n    let query = {\n      selector: { created: { $ne: null }, names: { $ne: null } },\n      sort: fields,\n      limit: this.list_per_page,\n      skip: (this.state.page_number - 1) * this.list_per_page\n    };\n    let app = this;\n    this.show_progress();\n    fetch(path, {\n      method: \"post\",\n      headers: default_headers,\n      body: JSON.stringify(query)\n    })\n      .then(response => {\n        if (response.ok) {\n          response.json().then(results => {\n            this.hide_progress();\n            app.setState({\n              queryset: results.rows\n                .filter(row => {\n                  return row.type == \"voter\";\n                })\n                .map(row => {\n                  return row.value;\n                }),\n              total: results.total_rows\n            });\n          });\n        } else {\n          this.hide_progress();\n        }\n      })\n      .catch(e => this.hide_progress());\n\n    return [];\n  }\n  search(term, queryset) {\n    let query = {\n      selector: {\n        $or: [\n          {\n            names: {\n              $regex: \"(?i)\" + term\n            }\n          },\n          {\n            emails: {\n              $elemMatch: {\n                $regex: \"(?i)\" + term\n              }\n            }\n          },\n          {\n            id: {\n              $regex: \"(?i)\" + term\n            }\n          }\n        ]\n      }\n      //\t    \"fields\" : [\"_id\",\"_rev\",\"id\",\"names\",\"phones\",\"emails\",\"allowed\",\"type\"],\n    };\n\n    let path = window.SERVER + \"/voters/_find\";\n    let app = this;\n    this.show_progress();\n\n    fetch(path, {\n      method: \"post\",\n      headers: default_headers,\n      body: JSON.stringify(query)\n    })\n      .then(response => {\n        if (response.ok) {\n          response.json().then(results => {\n            console.log(results);\n            this.hide_progress();\n            app.setState({\n              queryset: results.docs\n                .filter(row => {\n                  return row.type == \"voter\";\n                })\n                .map(row => {\n                  return row;\n                }),\n              total: 100\n            });\n          });\n        } else {\n          this.hide_progress();\n        }\n      })\n      .catch(e => this.hide_progress());\n\n    return queryset;\n  }\n  get_queryset(page_number, list_per_page, queryset) {\n    let path =\n      window.SERVER +\n      '/voters/_design/voter/_view/by_election?key=\"' +\n      window.ELECTION +\n      '\"&reduce=false' +\n      \"&limit=\" +\n      list_per_page +\n      \"&skip=\" +\n      (page_number - 1) * list_per_page;\n    console.log(path);\n    let app = this;\n    this.show_progress();\n    fetch(path, {\n      method: \"get\"\n    }).then(response => {\n      if (response.ok) {\n        response.json().then(results => {\n          this.hide_progress();\n          app.setState({\n            queryset: results.rows.map(row => {\n              return row.value;\n            }),\n            total: results.total_rows\n          });\n        });\n      }\n    });\n\n    return queryset;\n  }\n  get_form(object = null) {\n    let hidden = { \"ui:widget\": \"hidden\" };\n    let readonly = { \"ui:readonly\": \"true\" };\n    const uiSchema = {\n      //  id: readonly,\n      // names: readonly,\n      // emails: readonly,\n      // phones: readonly,\n      token: readonly,\n      authorization: hidden,\n      type: hidden\n    };\n\n    if (!object) {\n      return (\n        <Form\n          schema={this.schema}\n          uiSchema={uiSchema}\n          onSubmit={this.form_submit}\n        />\n      );\n    } else {\n      return (\n        <Form\n          schema={this.schema}\n          uiSchema={uiSchema}\n          formData={object}\n          onSubmit={this.form_submit}\n        />\n      );\n    }\n  }\n\n  form_submit(form) {\n    let voter = form.formData;\n\n    let id = voter[\"_id\"] ? voter[\"_id\"] : \"\";\n    let path = window.SERVER + \"/voters/\" + id;\n\n    console.log(path);\n\n    let url = form.edit ? path + \"?rev=\" + voter[\"_rev\"] : path;\n    let method = form.edit ? \"put\" : \"post\";\n    console.log(url);\n\n    fetch(url, {\n      method: method,\n      body: JSON.stringify(voter),\n      headers: default_headers\n    })\n      .then(response => {\n        if (response.ok) {\n          let action = form.edit ? this.response_change : this.response_add;\n\n          action();\n        } else {\n          alert(response.statusText);\n        }\n      })\n      .catch(response => {\n        alert(response);\n      });\n  }\n  has_add_permission() {\n    return true;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}